<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=360, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>검색</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="capture.css">
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <header class="header">
            <div class="header-top">
                <a href="main.html" class="back-button">
                    <span class="arrow">←</span>
                    <span class="back-text">뒤로가기</span>
                </a>
                <div class="app-title">
                    <span class="app-title-text"><span class="app-title-med">약</span><span class="app-title-rest">을먹자</span></span>
                    <img src="pill.png" class="pill-icon" alt="알약">
                </div>
            </div>
            <h1 class="main-title">검색</h1>
        </header>

        <!-- Main Content Section -->
        <main class="main-content">
            <p class="instruction-text">약 봉투 사진을 선택해주세요.</p>
            
            <!-- File Upload Area -->
            <div class="camera-container" id="cameraContainer">
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                <div class="camera-placeholder" id="cameraPlaceholder">
                    <p>이미지 업로드 영역</p>
                    <label for="fileInput" class="upload-button" id="uploadButtonLabel">
                        <button type="button" class="upload-button-inner" id="uploadButton">파일 선택</button>
                    </label>
                </div>
                <!-- 선택된 이미지 미리보기 -->
                <img id="previewImage" style="display: none; width: 100%; height: 100%; object-fit: contain; border-radius: 12px;" alt="선택된 이미지">
            </div>
        </main>

        <!-- Upload Button -->
        <button class="capture-button" id="processButton" style="display: none;">
            <img src="captureicon.png" alt="처리" class="capture-icon">
        </button>
    </div>

    <script>
        let selectedImageUri = null;
        const fileInput = document.getElementById('fileInput');
        const uploadButton = document.getElementById('uploadButton');
        const uploadButtonLabel = document.getElementById('uploadButtonLabel');
        const cameraPlaceholder = document.getElementById('cameraPlaceholder');
        const previewImage = document.getElementById('previewImage');
        const processButton = document.getElementById('processButton');

        // 파일 선택 버튼 클릭 이벤트 (모바일 대응)
        function triggerFileInput() {
            // 가장 확실한 방법: 직접 클릭
            try {
                fileInput.click();
            } catch (e) {
                console.error('파일 입력 클릭 오류:', e);
                // 대안: label 클릭
                if (uploadButtonLabel) {
                    uploadButtonLabel.click();
                }
            }
        }

        // 버튼 클릭 시 파일 선택
        uploadButton.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            triggerFileInput();
        });

        // 터치 이벤트 (모바일)
        uploadButton.addEventListener('touchend', (e) => {
            e.preventDefault();
            e.stopPropagation();
            triggerFileInput();
        });

        // label 클릭 (가장 확실한 방법)
        uploadButtonLabel.addEventListener('click', (e) => {
            // label이 자동으로 input을 클릭하므로 추가 작업 불필요
            e.stopPropagation();
        });

        // 파일 선택 이벤트
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files && event.target.files[0];
            if (!file) {
                console.log('파일이 선택되지 않았습니다.');
                return;
            }

            // 이미지 파일인지 확인
            if (!file.type || !file.type.startsWith('image/')) {
                alert('이미지 파일만 업로드 가능합니다.');
                fileInput.value = ''; // 입력 초기화
                return;
            }

            // 파일 크기 확인 (10MB 제한)
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                alert('파일 크기가 너무 큽니다. 10MB 이하의 이미지를 선택해주세요.');
                fileInput.value = '';
                return;
            }

            // FileReader를 사용하여 이미지를 base64로 변환
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    selectedImageUri = e.target.result;
                    
                    // 미리보기 표시
                    previewImage.src = selectedImageUri;
                    previewImage.style.display = 'block';
                    cameraPlaceholder.style.display = 'none';
                    
                    // 처리 버튼 표시
                    processButton.style.display = 'flex';
                    
                    console.log('이미지 선택 완료:', file.name, '크기:', file.size);
                } catch (error) {
                    console.error('이미지 처리 오류:', error);
                    alert('이미지를 처리하는 중 오류가 발생했습니다.');
                    fileInput.value = '';
                }
            };
            reader.onerror = () => {
                alert('파일을 읽는 중 오류가 발생했습니다.');
                fileInput.value = '';
            };
            reader.onabort = () => {
                console.log('파일 읽기가 취소되었습니다.');
                fileInput.value = '';
            };
            reader.readAsDataURL(file);
        });

        // 파일 input 변경 감지 (디버깅)
        fileInput.addEventListener('focus', () => {
            console.log('파일 input 포커스됨');
        });

        // 백엔드 API URL 설정 (config.js에서 가져오거나 기본값 사용)
        const API_BASE_URL = (typeof API_CONFIG !== 'undefined' && API_CONFIG.BASE_URL) || 'https://sibaljom.onrender.com/api';
        
        // 이미지를 서버로 전송하여 OCR 처리
        async function uploadAndProcessImage(imageBase64) {
            try {
                // 로딩 표시
                previewImage.style.display = 'none';
                cameraPlaceholder.style.display = 'flex';
                cameraPlaceholder.innerHTML = '<p style="color: #5271ff;">이미지 분석 중...</p>';
                
                const response = await fetch(`${API_BASE_URL}/ocr`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        image: imageBase64
                    })
                });
                
                if (!response.ok) {
                    // 더 자세한 에러 정보 가져오기
                    let errorMessage = '서버 응답 오류';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorData.message || `서버 오류 (${response.status})`;
                    } catch (e) {
                        errorMessage = `서버 오류 (${response.status} ${response.statusText})`;
                    }
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // 약 정보 저장 (localStorage에 저장)
                    const medications = JSON.parse(localStorage.getItem('medications') || '[]');
                    
                    // 등록 날짜 기준으로 약 정보 저장
                    const medicationData = {
                        ...data.medication,
                        registered_date: new Date().toISOString().split('T')[0], // YYYY-MM-DD 형식
                        registered_timestamp: new Date().toISOString()
                    };
                    
                    medications.push(medicationData);
                    localStorage.setItem('medications', JSON.stringify(medications));
                    
                    // 백엔드에도 저장 (동기화)
                    try {
                        await fetch(`${API_BASE_URL}/medications`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(medicationData)
                        });
                    } catch (error) {
                        console.error('백엔드 저장 오류:', error);
                        // 백엔드 저장 실패해도 localStorage에 저장된 정보는 유지
                    }
                    
                    const mealInfo = medicationData.before_meal ? '식전' : '식후';
                    alert(`약 정보가 등록되었습니다!\n약 이름: ${medicationData.name}\n복용 횟수: 1일 ${medicationData.dosage}회\n복용 기간: ${medicationData.days}일\n복용 시기: ${mealInfo}`);
                    
                    // 메인 화면으로 이동
                    setTimeout(() => {
                        window.location.href = 'main.html';
                    }, 1000);
                } else {
                    throw new Error(data.error || '약 정보를 추출할 수 없습니다. 다시 시도해주세요.');
                }
            } catch (error) {
                console.error('OCR 처리 오류:', error);
                alert('이미지 분석 중 오류가 발생했습니다: ' + error.message);
                // 에러 발생 시 다시 미리보기 표시
                previewImage.style.display = 'block';
                cameraPlaceholder.style.display = 'none';
            }
        }

        // 처리 버튼 클릭 이벤트
        processButton.addEventListener('click', () => {
            if (selectedImageUri) {
                uploadAndProcessImage(selectedImageUri);
            } else {
                alert('이미지를 선택해주세요.');
            }
        });

        // 다시 선택하기 기능 (이미지 클릭 시)
        previewImage.addEventListener('click', () => {
            if (confirm('다른 이미지를 선택하시겠습니까?')) {
                selectedImageUri = null;
                previewImage.style.display = 'none';
                cameraPlaceholder.style.display = 'flex';
                processButton.style.display = 'none';
                fileInput.value = '';
            }
        });
    </script>
</body>
</html>

