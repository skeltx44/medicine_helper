<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=360, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>이달의 약</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="thismonth.css">
</head>
<body>
    <div class="container">
        <!-- Header Section -->
        <header class="header">
            <div class="header-top">
                <a href="main.html" class="back-button">
                    <span class="arrow">←</span>
                    <span class="back-text">뒤로가기</span>
                </a>
                <div class="app-title">
                    <span class="app-title-text"><span class="app-title-med">약</span><span class="app-title-rest">을먹자</span></span>
                    <img src="pill.png" class="pill-icon" alt="알약">
                </div>
            </div>
            <h1 class="main-title">이달의 약</h1>
        </header>

        <!-- Main Content Section -->
        <main class="main-content">
            <div class="calendar-container">
                <div class="calendar-header">
                    <div class="month-year" id="monthYear"></div>
                </div>
                <div class="calendar-weekdays">
                    <div class="weekday">일</div>
                    <div class="weekday">월</div>
                    <div class="weekday">화</div>
                    <div class="weekday">수</div>
                    <div class="weekday">목</div>
                    <div class="weekday">금</div>
                    <div class="weekday">토</div>
                </div>
                <div class="calendar-grid" id="calendarGrid">
                    <!-- Calendar days will be generated by JavaScript -->
                </div>
            </div>
        </main>
    </div>

    <script src="config.js"></script>
    <script>
        const API_BASE_URL = (typeof API_CONFIG !== 'undefined' && API_CONFIG.BASE_URL) || 'https://sibaljom.onrender.com/api';
        
        // 현재 날짜 가져오기
        const now = new Date();
        let currentYear = now.getFullYear();
        let currentMonth = now.getMonth();
        let dailyStatuses = {}; // 날짜별 복용 상태 저장 (YYYY-MM-DD 형식)

        // 일일 복용 상태 불러오기 (백엔드 /api/history/month 엔드포인트 사용)
        async function loadDailyStatuses(year, month) {
            try {
                const response = await fetch(`${API_BASE_URL}/history/month?year=${year}&month=${month + 1}`);
                if (response.ok) {
                    const data = await response.json();
                    // 백엔드 응답에서 daily_status 추출
                    if (data && typeof data.daily_status === 'object') {
                        dailyStatuses = data.daily_status;
                    } else {
                        console.warn('daily_status가 올바른 형식이 아닙니다:', data);
                        dailyStatuses = {}; // 비정상 형식 시 빈 객체로 초기화
                    }
                } else {
                    console.error('일일 상태 불러오기 실패:', response.status, response.statusText);
                    dailyStatuses = {}; // 에러 시 빈 객체로 초기화
                }
            } catch (error) {
                console.error('일일 상태 불러오기 오류:', error);
                dailyStatuses = {}; // 에러 시 빈 객체로 초기화
            }
        }

        // 날짜에 O/X 표시 추가
        function addStatusMark(markContainer, status) {
            // status가 없거나 유효하지 않으면 표시하지 않음
            if (!status || (status !== 'O' && status !== 'X')) {
                markContainer.innerHTML = '';
                return;
            }
            
            markContainer.innerHTML = '';
            
            if (status === 'O') {
                // 완료 상태: 초록색 원 표시
                const circleMark = document.createElement('div');
                circleMark.className = 'mark-circle';
                circleMark.textContent = '○';
                markContainer.appendChild(circleMark);
            } else if (status === 'X') {
                // 미완료 상태: 빨간색 X 표시
                const crossMark = document.createElement('div');
                crossMark.className = 'mark-cross';
                crossMark.textContent = '✕';
                markContainer.appendChild(crossMark);
            }
        }

        // 달력 생성 함수
        async function generateCalendar(year, month) {
            // 먼저 일일 상태 불러오기
            await loadDailyStatuses(year, month);
            const monthYearElement = document.getElementById('monthYear');
            const calendarGrid = document.getElementById('calendarGrid');
            
            // 월/년도 표시
            monthYearElement.textContent = `${year}.${String(month + 1).padStart(2, '0')}`;
            
            // 달력 그리드 초기화
            calendarGrid.innerHTML = '';
            
            // 해당 월의 첫 번째 날과 마지막 날
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();
            
            // 이전 달의 마지막 날들 (빈 칸 채우기)
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = startingDayOfWeek - 1; i >= 0; i--) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = prevMonthLastDay - i;
                dayElement.appendChild(dayNumber);
                
                const dayContent = document.createElement('div');
                dayContent.className = 'day-content';
                dayElement.appendChild(dayContent);
                
                calendarGrid.appendChild(dayElement);
            }
            
            // 현재 달의 날들
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                
                // 오늘 날짜 체크
                if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                    dayElement.classList.add('today');
                }
                
                // 일요일 체크
                const dayOfWeek = new Date(year, month, day).getDay();
                if (dayOfWeek === 0) {
                    dayElement.classList.add('sunday');
                }
                
                // 일수 표시
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);
                
                // 날짜 내용 영역 (OX 표시 포함)
                const dayContent = document.createElement('div');
                dayContent.className = 'day-content';
                dayElement.appendChild(dayContent);
                
                // OX 표시 영역
                const markContainer = document.createElement('div');
                markContainer.className = 'day-mark';
                dayContent.appendChild(markContainer);
                
                // 날짜 문자열 생성 (YYYY-MM-DD 형식)
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                // 저장된 상태가 있으면 표시, 없으면 기본값 'X' (daily_status에 없는 날짜는 미완료로 처리)
                const status = dailyStatuses[dateStr] || 'X';
                addStatusMark(markContainer, status);
                
                calendarGrid.appendChild(dayElement);
            }
            
            // 다음 달의 첫 날들 (빈 칸 채우기)
            const totalCells = calendarGrid.children.length;
            const remainingCells = 42 - totalCells; // 6주 * 7일 = 42
            for (let day = 1; day <= remainingCells; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day other-month';
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);
                
                const dayContent = document.createElement('div');
                dayContent.className = 'day-content';
                dayElement.appendChild(dayContent);
                
                calendarGrid.appendChild(dayElement);
            }
        }
        
        // 페이지 로드 시 달력 생성
        async function initCalendar() {
            await generateCalendar(currentYear, currentMonth);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initCalendar);
        } else {
            initCalendar();
        }
    </script>
</body>
</html>

